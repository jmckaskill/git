#include "cache.h"

static const signed char base64_dec[256] = {
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* 00-07 */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* 08-0f */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* 10-17 */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* 18-1f */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* 20-27 */
	 -1, -1, -1, 62, -1, -1, -1, 63,		/* 28-2f */
	 52, 53, 54, 55, 56, 57, 58, 59,		/* 30-37 */
	 60, 61, -1, -1, -1,  0, -1, -1,		/* 38-3f */
	 -1,  0,  1,  2,  3,  4,  5,  6,		/* 40-47 */
	  7,  8,  9, 10, 11, 12, 13, 14,		/* 48-4f */
	 15, 16, 17, 18, 19, 20, 21, 22,		/* 50-57 */
	 23, 24, 25, -1, -1, -1, -1, -1,		/* 58-5f */
	 -1, 26, 27, 28, 29, 30, 31, 32,		/* 60-67 */
	 33, 34, 35, 36, 37, 38, 39, 40,		/* 68-6f */
	 41, 42, 43, 44, 45, 46, 47, 48,		/* 70-77 */
	 49, 50, 51, -1, -1, -1, -1, -1,		/* 78-7f */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* 80-87 */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* 88-8f */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* 90-97 */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* 98-9f */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* a0-a7 */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* a8-af */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* b0-b7 */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* b8-bf */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* c0-c7 */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* c8-cf */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* d0-d7 */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* d8-df */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* e0-e7 */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* e8-ef */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* f0-f7 */
	 -1, -1, -1, -1, -1, -1, -1, -1,		/* f8-ff */
};

static const char base64_enc[] =
	"ABCDEFGHIJKLMNOP"
	"QRSTUVWXYZabcdef"
	"ghijklmnopqrstuv"
	"wxyz0123456789+/";

void decode_64(struct strbuf *buf) {
	unsigned char *p = (unsigned char*) buf->buf;
	unsigned char *e = p + buf->len;
	unsigned char *o = p;

	while (p + 4 <= e) {
		unsigned int val = 0;
		val |= base64_dec[*(p++)] << 18;
		val |= base64_dec[*(p++)] << 12;
		val |= base64_dec[*(p++)] << 6;
		val |= base64_dec[*(p++)];

		if (val & ~0xffffff)
			goto err;

		*(o++) = (unsigned char) (val >> 16);
		*(o++) = (unsigned char) (val >> 8);
		*(o++) = (unsigned char) val;

		if (p[-2] == '=') o--;
		if (p[-1] == '=') o--;

		while (p < e && isspace(*p))
			p++;
	}

	if (p != e) goto err;

	strbuf_setlen(buf, (char*) o - buf->buf);
	return;

err:
	die("invalid base64");
}
